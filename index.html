<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mis XV – Memories</title>
<style>
  /* Paleta inspirada en el vestido: bronce + carbón + esmeralda */
  :root{
    --bg:#0e0f12;
    --card:#14161c;
    --muted:#b7becb;
    --copper1:#a66a54;  /* bronce suave */
    --copper2:#d19a7d;  /* bronce claro */
    --emerald:#22c3a6;  /* acento esmeralda */
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:#f7f9fc;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 50% -10%, #1d212a 0, var(--bg) 55%),
      linear-gradient(180deg,#0b0c10, #0e0f12);
  }
  /* Header */
  header{ text-align:center; padding:28px 16px 6px }
  header h1{ margin:6px 0 2px; font-size:clamp(22px,3.6vw,36px); letter-spacing:.3px }
  header p{ margin:0; color:var(--muted); font-size:14px }

  .container{ max-width:1100px; margin:0 auto; padding:12px 16px 40px }

  /* Tarjeta de subida */
  .uploader{
    background:linear-gradient(180deg, #151821, #11141a);
    border-radius:var(--radius);
    padding:16px; display:grid; gap:12px;
    box-shadow:0 20px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
  }
  .row{ display:grid; gap:12px; grid-template-columns:1fr auto; align-items:center }
  .dropzone{
    border:2px dashed rgba(214,160,136,.5);
    border-radius:16px; padding:18px; text-align:center; cursor:pointer;
    background:#131722; transition:.25s;
  }
  .dropzone:hover{ border-color:var(--copper2); box-shadow:0 0 0 2px rgba(209,154,125,.25) inset }
  .help{ color:var(--muted); font-size:13px }

  .btn{
    background:linear-gradient(90deg,var(--copper1),var(--copper2));
    color:#0d0f14; border:0; padding:12px 16px; border-radius:14px;
    font-weight:800; cursor:pointer; letter-spacing:.2px;
    box-shadow:0 8px 20px rgba(209,154,125,.35);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none }

  /* Input accesible para iOS/Android */
  .visually-hidden{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0 }

  /* Previews */
  .previews{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px }
  .preview{ position:relative; background:#0d1018; border:1px solid rgba(255,255,255,.07); border-radius:12px; padding:6px }
  .preview img,.preview video{ width:100%; height:100px; object-fit:cover; border-radius:8px; display:block }
  .bar{ position:absolute; left:6px; right:6px; bottom:6px; height:6px; border-radius:6px; background:#222a39; overflow:hidden }
  .bar>span{ display:block; width:0%; height:100%;
    background:linear-gradient(90deg, var(--emerald), #6ff0d8); transition:width .2s }

  /* Carrusel tipo app */
  .carousel-wrap{ margin-top:20px }
  .title{ margin:0 6px 8px; color:#e8eef8; font-size:16px }
  .carousel{ display:flex; gap:12px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:6px }
  .carousel::-webkit-scrollbar{ display:none }
  .slide{
    flex:0 0 78vw; max-width:440px; scroll-snap-align:center;
    background:linear-gradient(180deg,#161a24,#11141a);
    border:1px solid rgba(255,255,255,.06); border-radius:16px; overflow:hidden;
  }
  .thumb{ aspect-ratio:16/9; background:#0b0e14 }
  .slide img,.slide video{ width:100%; height:100%; object-fit:cover; display:block }
  .chip{ position:absolute; top:10px; left:10px; background:rgba(14,17,22,.6); border:1px solid rgba(255,255,255,.12); color:#fff; padding:4px 8px; font-size:11px; border-radius:999px; backdrop-filter:blur(4px)}
  .slide .meta{ display:flex; justify-content:space-between; align-items:center; padding:10px }
  .name{ font-size:13px; color:#f3f7ff; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .dl{ font-size:12px; color:#0e1116; background:linear-gradient(90deg,#41dfc6,#72ffe8); border-radius:10px; padding:6px 8px; font-weight:800; text-decoration:none }

  /* Galería grid */
  .gallery{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px }
  .card{ background:linear-gradient(180deg,#151a23,#10131a); border:1px solid rgba(255,255,255,.06); border-radius:16px; overflow:hidden; display:flex; flex-direction:column }
  .thumb-square{ aspect-ratio:1/1; background:#0b0e14 }
  .thumb-square img,.thumb-square video{ width:100%; height:100%; object-fit:cover }
  .meta{ padding:10px; display:flex; justify-content:space-between; align-items:center; gap:8px }
  @media (min-width:900px){ .slide{ flex-basis:380px } }
</style>
</head>
<body>
  <header>
    <h1>Mis XV – Memories</h1>
    <p>Sube tus fotos y videos. Se verán aquí mismo y podrás descargarlos.</p>
  </header>

  <main class="container">
    <section class="uploader">
      <div class="row">
        <!-- LABEL para abrir el selector (móviles) -->
        <label class="dropzone" for="fileInput">
          <div><strong>Toca o arrastra archivos aquí</strong></div>
          <div class="help">Formato: JPG, PNG, HEIC*, MP4, MOV, etc.</div>
        </label>
        <button class="btn" id="uploadBtn" disabled>Subir recuerdos a la nube</button>
      </div>
      <!-- input accesible (no display:none) -->
      <input id="fileInput" class="visually-hidden" type="file" accept="image/*,video/*" multiple>
      <div class="previews" id="previews"></div>
    </section>

    <section class="carousel-wrap">
      <h3 class="title">Destacados</h3>
      <div class="carousel" id="carousel"></div>
    </section>

    <section>
      <h3 class="title" style="margin-top:18px">Galería completa</h3>
      <div class="gallery" id="gallery"></div>
    </section>
  </main>

<script>
  // URL de tu Apps Script
  const API_URL = 'https://script.google.com/macros/s/AKfycbyYTLXKAfpg5pN8N5UDhxL-PJP94OdKSbRRTtpWRL3KkQ4fjMgTOflZCJ6hP_q143Yu/exec';

  const input = document.getElementById('fileInput');
  const btn = document.getElementById('uploadBtn');
  const previews = document.getElementById('previews');
  const gallery = document.getElementById('gallery');
  const carousel = document.getElementById('carousel');

  let queue = [];

  function bytesToBase64(arrBuf){
    let binary=''; const bytes=new Uint8Array(arrBuf);
    for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  function addPreview(file){
    const wrap=document.createElement('div'); wrap.className='preview';
    let media;
    if(file.type.startsWith('video/')){
      media=document.createElement('video'); media.src=URL.createObjectURL(file); media.muted=true; media.playsInline=true;
    }else{
      media=document.createElement('img'); media.src=URL.createObjectURL(file); media.alt=file.name;
    }
    const bar=document.createElement('div'); bar.className='bar';
    const span=document.createElement('span'); bar.appendChild(span);
    wrap.appendChild(media); wrap.appendChild(bar);
    previews.appendChild(wrap);
    return span;
  }

  function onFilesSelected(list){
    Array.from(list).forEach(f=>{
      if(!/^(image|video)\//.test(f.type)) return;
      const progressEl=addPreview(f);
      queue.push({file:f,progressEl});
    });
    btn.disabled = queue.length===0;
  }

  // Eventos
  input.addEventListener('change', e=>onFilesSelected(e.target.files));
  document.addEventListener('dragover', e=>{ e.preventDefault(); });
  document.addEventListener('drop', e=>{ e.preventDefault(); onFilesSelected(e.dataTransfer.files); });

  // Enviar sin preflight (evita "Failed to fetch")
  async function uploadQueue(){
    btn.disabled = true;
    const payloadFiles=[];
    for(const item of queue){
      const buf=await item.file.arrayBuffer();
      payloadFiles.push({ name:item.file.name, mimeType:item.file.type, bytes:bytesToBase64(buf) });
    }
    try{
      const resp = await fetch(API_URL,{
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // <- evita preflight
        body:JSON.stringify({ files: payloadFiles })
      });
      if(!resp.ok) throw new Error(resp.status+' '+resp.statusText);
      const res=await resp.json();

      queue.forEach(q=>q.progressEl.style.width='100%');
      queue=[]; input.value=''; setTimeout(()=>{previews.innerHTML='';},600);

      if(res && res.ok) renderAll(res.files,true);
    }catch(err){
      alert('Error subiendo: '+err.message);
    }finally{
      btn.disabled=false;
    }
  }
  btn.addEventListener('click', uploadQueue);

  function drivePreviewSrc(file){
    if(file.mimeType.startsWith('image/')) return `https://drive.google.com/uc?export=view&id=${file.id}`;
    if(file.mimeType.startsWith('video/')) return `https://drive.google.com/uc?export=download&id=${file.id}`;
    return `https://drive.google.com/uc?export=view&id=${file.id}`;
  }
  function driveDownloadHref(file){ return `https://drive.google.com/uc?export=download&id=${file.id}`; }

  function renderAll(files, prepend=false){
    // Carrusel (últimos 10)
    const top = files.slice(0,10);
    const cfrag=document.createDocumentFragment();
    top.forEach(f=>{
      const slide=document.createElement('div'); slide.className='slide';
      const t=document.createElement('div'); t.className='thumb'; t.style.position='relative';
      const chip=document.createElement('div'); chip.className='chip'; chip.textContent=f.mimeType.startsWith('video/')?'Video':'Foto';
      let m;
      if(f.mimeType.startsWith('video/')){ m=document.createElement('video'); m.src=drivePreviewSrc(f); m.muted=true; m.playsInline=true; m.controls=true; }
      else{ m=document.createElement('img'); m.src=drivePreviewSrc(f); m.alt=f.name; }
      t.appendChild(m); t.appendChild(chip);
      const meta=document.createElement('div'); meta.className='meta';
      const name=document.createElement('div'); name.className='name'; name.textContent=f.name;
      const a=document.createElement('a'); a.className='dl'; a.href=driveDownloadHref(f); a.target='_blank'; a.rel='noopener'; a.textContent='Descargar';
      meta.appendChild(name); meta.appendChild(a);
      slide.appendChild(t); slide.appendChild(meta);
      cfrag.appendChild(slide);
    });
    if(prepend) carousel.prepend(cfrag); else { carousel.innerHTML=''; carousel.appendChild(cfrag); }

    // Grid completo
    const gfrag=document.createDocumentFragment();
    files.forEach(f=>{
      const card=document.createElement('div'); card.className='card';
      const t=document.createElement('div'); t.className='thumb-square';
      let m;
      if(f.mimeType.startsWith('video/')){ m=document.createElement('video'); m.src=drivePreviewSrc(f); m.muted=true; m.playsInline=true; m.controls=true; }
      else{ m=document.createElement('img'); m.src=drivePreviewSrc(f); m.alt=f.name; }
      t.appendChild(m);
      const meta=document.createElement('div'); meta.className='meta';
      const name=document.createElement('div'); name.className='name'; name.textContent=f.name;
      const a=document.createElement('a'); a.className='dl'; a.href=driveDownloadHref(f); a.target='_blank'; a.rel='noopener'; a.textContent='Descargar';
      meta.appendChild(name); meta.appendChild(a);
      card.appendChild(t); card.appendChild(meta);
      gfrag.appendChild(card);
    });
    if(prepend) gallery.prepend(gfrag); else { gallery.innerHTML=''; gallery.appendChild(gfrag); }
  }

  async function loadGallery(){
    try{
      const res=await fetch(API_URL).then(r=>r.json());
      if(res && res.ok){ renderAll(res.files); startAutoplay(); }
    }catch(e){ console.error(e); }
  }

  // Autoplay del carrusel
  let autoplayTimer;
  function startAutoplay(){
    clearInterval(autoplayTimer);
    autoplayTimer = setInterval(()=>{
      if(!carousel.children.length) return;
      const next = Math.min(carousel.scrollLeft + carousel.clientWidth*0.92, carousel.scrollWidth);
      carousel.scrollTo({ left: next, behavior:'smooth' });
      if(carousel.scrollLeft + carousel.clientWidth >= carousel.scrollWidth - 4){
        setTimeout(()=>carousel.scrollTo({ left:0, behavior:'smooth' }), 1500);
      }
    }, 3200);
  }

  loadGallery();
</script>
</body>
</html>
